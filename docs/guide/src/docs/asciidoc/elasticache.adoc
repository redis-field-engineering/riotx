:ec: ElastiCache

[[_elasticache]]
= {ec} Migration

This recipe contains step-by-step instructions to migrate an {ec} (EC) database to {link_redis_cloud} or {link_redis_software}.

The following scenarios are covered:

* One-time (snapshot) migration
* Online (live) migration

IMPORTANT: It is recommended to read the <<_replication,Replication>> section to familiarize yourself with its usage and architecture.

== Setup

=== Prerequisites

For this recipe you will require the following resources:
 
* AWS {ec}: _Primary Endpoint_ in case of Single Master and _Configuration Endpoint_ in case of Clustered EC.
Refer to https://docs.aws.amazon.com/AmazonElastiCache/latest/red-ug/Endpoints.html[this link] to learn more
* {link_redis_cloud} or {link_redis_software}
* An Amazon EC2 instance to run {project-title}

[IMPORTANT]
.Keyspace Notifications
====
For a live migration you need to enable keyspace notifications on your {ec} instance (see {link_ec_notifications}).
====

=== Migration Host

To run the migration tool we will need an EC2 instance.

You can either create a new EC2 instance or leverage an existing one if available.
In the example below we first create an instance on AWS Cloud Platform.
The most common scenario is to access an {ec} cluster from an Amazon EC2 instance in the same Amazon Virtual Private Cloud (Amazon VPC).
We have used Ubuntu 16.04 LTS for this setup but you can choose any Ubuntu or Debian distribution of your choice.
 
SSH to this EC2 instance from your laptop:

[source,console]
----
ssh -i “public key” <AWS EC2 Instance>
----

Install `redis-cli` on this new instance by running this command:

[source,console]
----
sudo apt update
sudo apt install -y redis-tools
----

Use `redis-cli` to check connectivity with the {ec} database:

[source,console]
----
redis-cli -h <ec primary endpoint> -p 6379
----

Ensure that the above command allows you to connect to the remote {ec} database successfully.


=== Installing {project-title}

Let's install {project-title} on the EC2 instance we set up previously.
For this we'll follow the steps in <<_install_manual,Manual Installation>>.

== Performing Migration

We are now all set to begin the migration process.
The options you will use depend on your source and target databases, as well as the replication mode (snapshot or live).

=== {ec} Single Master -> Redis
[source,console,subs="verbatim,attributes"]
----
{app} replicate source:port target:port
----

=== Live {ec} Single Master -> Redis
[source,console,subs="verbatim,attributes"]
----
{app} replicate source:port target:port --mode live
----

[IMPORTANT]
====
In case {ec} is configured with https://docs.aws.amazon.com/Amazon{ec}/latest/red-ug/auth.html[AUTH TOKEN enabled], you need to pass `--source-tls` as well as `--source-pass` option:

[source,console,subs="verbatim,attributes,+quotes"]
----
{app} replicate source:port target:port --source-tls --source-pass <password>
----
====

=== {ec} Cluster -> Redis

[source,console,subs="verbatim,attributes"]
----
{app} replicate source:port target:port --source-cluster
----

NOTE: `--cluster` is an important parameter used ONLY for {ec} whenever cluster-mode is enabled.
Do note that the source database is specified first and the target database is specified after the replicate command and it is applicable for all the scenarios.

=== {ec} Single Master -> Redis (with specific database index)

[source,console,subs="verbatim,attributes"]
----
{app} replicate redis://source:port/db target:port
----

=== {ec} Single Master -> Redis with OSS Cluster
[source,console,subs="verbatim,attributes"]
----
{app} replicate source:port target:port --target-cluster
----

=== Live {ec} Cluster -> Redis with OSS Cluster

[source,console,subs="verbatim,attributes"]
----
{app} replicate source:port target:port --source-cluster --target-cluster --mode live
----

== Important Considerations

* It is recommended to test migration in UAT before production use.
* Once migration is completed, ensure that application traffic gets redirected to Redis endpoint successfully.
* It is recommended to perform the migration process during low traffic hours so as to avoid chances of data loss.

== CloudFormation Template for AWS ECS

For users who prefer to run migrations using AWS ECS Fargate, a CloudFormation template is available that automates the deployment of RIOT-X replication tasks.

The template link:{site-url}/riot-migration.yaml[riot-migration.yaml] creates an ECS task definition that can be used to run ElastiCache to Redis migrations in a containerized environment.

=== Key Features

* **Automated ECS Task Definition**: Creates a Fargate-compatible task definition with configurable CPU and memory settings
* **Environment Variable Configuration**: All RIOT-X parameters are exposed as CloudFormation parameters and passed as environment variables
* **IAM Role Management**: Automatically creates the necessary execution role if not provided
* **CloudWatch Logging**: Integrated logging to CloudWatch with configurable log levels
* **Security**: Sensitive parameters like passwords are marked with NoEcho for security

=== Usage

==== Using AWS CLI

1. Deploy the CloudFormation template:
+
[source,console]
----
aws cloudformation create-stack \
  --stack-name elasticache-migration \
  --template-body file://riot-migration.yaml \
  --parameters ParameterKey=SourceRedisURI,ParameterValue=rediss://source-host:6379 \
               ParameterKey=TargetRedisURI,ParameterValue=redis://target-host:19619 \
  --capabilities CAPABILITY_IAM
----

2. Run the migration task using ECS:
+
[source,console]
----
aws ecs run-task \
  --cluster your-cluster-name \
  --task-definition task-definition-cfn \
  --launch-type FARGATE \
  --network-configuration "awsvpcConfiguration={subnets=[subnet-12345],securityGroups=[sg-12345],assignPublicIp=ENABLED}"
----

==== Using AWS Management Console

1. **Deploy the CloudFormation Stack:**
   a. Navigate to the AWS CloudFormation console
   b. Click *Create stack* → *With new resources (standard)*
   c. Under *Template source*, select *Upload a template file*
   d. Click *Choose file* and upload the `riot-migration.yaml` template
   e. Click *Next*
   f. Enter a stack name (e.g., `elasticache-migration`)
   g. Fill in the required parameters:
      * *SourceRedisURI*: Your ElastiCache endpoint (e.g., `rediss://source-host:6379`)
      * *TargetRedisURI*: Your target Redis endpoint (e.g., `redis://target-host:19619`)
      * Configure additional parameters as needed (authentication, clustering, performance settings)
   h. Click *Next* through the stack options
   i. On the review page, check *I acknowledge that AWS CloudFormation might create IAM resources*
   j. Click *Submit*
   k. Wait for the stack to reach *CREATE_COMPLETE* status

2. **Run the Migration Task:**
   a. Navigate to the Amazon ECS console
   b. Select your cluster or create a new one if needed
   c. Click *Tasks* tab, then *Run new task*
   d. Select *Launch type*: *Fargate*
   e. Under *Task definition*, select the family created by CloudFormation (default: `task-definition-cfn`)
   f. Choose the latest revision
   g. Configure networking:
      * Select your VPC
      * Choose subnets (ensure they have internet access for pulling container images)
      * Select or create a security group allowing outbound connections
      * Enable *Auto-assign public IP* if using public subnets
   h. Click *Run task*
   i. Monitor the task status and logs in the ECS console

3. **Monitor Progress:**
   a. Go to CloudWatch Logs
   b. Find the log group `/ecs/fargate-task-definition` (or the custom log group you specified)
   c. View the log stream to monitor migration progress and any errors

=== Configuration Parameters

The template supports all major RIOT-X replication parameters including:

* **Connection Settings**: Source/target URIs, TLS configuration, authentication
* **Replication Mode**: SCAN (snapshot), LIVE (continuous), or LIVEONLY
* **Performance Tuning**: Batch sizes, thread counts, memory limits
* **Filtering**: Key patterns, key types, memory limits
* **Monitoring**: Progress reporting, logging levels, CloudWatch integration

Refer to the template parameters for complete configuration options and their descriptions.


